<!DOCTYPE html>
<html lang="it">
    <link rel="apple-touch-icon" href="icona.png">
    <link rel="icon" href="icona.png"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioCircuito v1.0.0</title>
    <style>
        body { background-color: #000000; color: #ffffff; font-family: -apple-system, sans-serif; text-align: center; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 90vh; justify-content: space-between; overflow: hidden; }
        #setup-area { padding: 10px; border-bottom: 1px solid #222; margin-bottom: 10px; font-size: 0.9rem; color: #00e676; }
        #workout-area { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .hidden { display: none !important; }
        #status-bar { font-size: 2rem; color: #007bff; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        #current-exercise { font-size: 4rem; font-weight: bold; margin-bottom: 10px; line-height: 1.1; min-height: 4.5rem; }
        #timer { font-size: 10rem; font-weight: bold; margin: 5px 0; color: #ffffff; font-variant-numeric: tabular-nums; }
        #next-exercise { font-size: 2.2rem; color: #aaaaaa; min-height: 2.5rem; }
        button.start { background-color: #00e676; color: black; font-size: 2.5rem; font-weight: bold; padding: 30px; width: 100%; border-radius: 20px; border: none; cursor: pointer; }
        .color-prep { color: #ffd600 !important; } 
        .color-go { color: #00e676 !important; }   
        .color-rest { color: #ff1744 !important; } 
    </style>
</head>
<body>

    <div id="setup-area">Configurazione in caricamento...</div>

    <div id="workout-area">
        <div id="status-bar">---</div>
        <div id="current-exercise">Pronto</div>
        <div id="timer">00</div>
        <div id="next-exercise">---</div>
        <button id="btn-start" class="start hidden">INIZIA</button>
    </div>

    <script>
        // CONFIGURAZIONE
        const VERSION = "1.0.0";
        const jsonUrl = 'circuito.json'; // Carica il file locale o dal repo GitHub

        let circuitoDati = null;
        let wakeLock = null;
        
        const elStatus = document.getElementById('status-bar');
        const elEsercizio = document.getElementById('current-exercise');
        const elTimer = document.getElementById('timer');
        const elProssimo = document.getElementById('next-exercise');
        const elSetup = document.getElementById('setup-area');
        const btnStart = document.getElementById('btn-start');

        // 1. CARICAMENTO AUTOMATICO JSON
        async function caricaConfigurazione() {
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error('File non trovato');
                const data = await response.json();
                circuitoDati = data.circuito;
                elSetup.innerText = `v${VERSION} - Circuito Pronto`;
                btnStart.classList.remove('hidden');
                elStatus.innerText = `GIRI TOTALI: ${circuitoDati.giri_totali}`;
            } catch (err) {
                elSetup.innerText = "ERRORE: Caricare circuito.json nella cartella";
                elSetup.style.color = "red";
            }
        }

        function parla(testo) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const msg = new SpeechSynthesisUtterance(testo);
                msg.lang = 'it-IT';
                window.speechSynthesis.speak(msg);
            }
        }

        async function attivaWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        const attendi = (ms) => new Promise(res => setTimeout(res, ms));

        // 2. LOGICA ALLENAMENTO
        btnStart.addEventListener('click', async () => {
            btnStart.classList.add('hidden');
            elSetup.classList.add('hidden');
            attivaWakeLock();
            
            // BRIEFING INIZIALE
            const primo = circuitoDati.esercizi[0];
            parla(`Allenamento iniziato. Primo esercizio: ${primo.nome}.`);
            
            elEsercizio.innerText = "Prepararsi...";
            elTimer.className = "color-prep";
            
            for(let i = 10; i > 0; i--) {
                elTimer.innerText = i;
                if(i === 5) parla(`Prepararsi per ${primo.nome}`);
                if(i <= 3) parla(i.toString());
                await attendi(1000);
            }

            // CICLO GIRI
            for (let g = circuitoDati.giri_totali; g >= 1; g--) {
                elStatus.innerText = `GIRO ${g} DI ${circuitoDati.giri_totali}`;
                
                for (let i = 0; i < circuitoDati.esercizi.length; i++) {
                    const es = circuitoDati.esercizi[i];
                    const prox = circuitoDati.esercizi[i + 1];

                    // ESECUZIONE
                    elEsercizio.innerText = es.nome;
                    elProssimo.innerText = prox ? `Prossimo: ${prox.nome}` : "Fine del giro";
                    elTimer.className = "color-go";
                    
                    if (es.tipo === "a_tempo") {
                        parla(`Via. ${es.durata_complessiva_secondi} secondi.`);
                        for(let t = es.durata_complessiva_secondi; t > 0; t--) {
                            elTimer.innerText = t;
                            if (t % 10 === 0 && t > 10) parla(t.toString());
                            if (t === 10) parla("Dieci secondi");
                            if (t <= 3) parla(t.toString());
                            await attendi(1000);
                        }
                    } else {
                        parla("Via!");
                        for(let r = es.numero_ripetizioni; r > 0; r--) {
                            parla(r.toString());
                            for(let t = es.tempo_singola_ripetizione_secondi; t > 0; t--) {
                                elTimer.innerText = t;
                                await attendi(1000);
                            }
                        }
                    }

                    // PAUSA
                    if (i < circuitoDati.esercizi.length - 1) {
                        elEsercizio.innerText = "Pausa";
                        elTimer.className = "color-rest";
                        
                        let infoProx = `${prox.nome}. ` + (prox.tipo === "a_tempo" ? `${prox.durata_complessiva_secondi} secondi` : `${prox.numero_ripetizioni} ripetizioni`);
                        parla(`Pausa. Prossimo esercizio: ${infoProx}`);
                        
                        let pEffettiva = circuitoDati.pausa_tra_esercizi_secondi - prox.tempo_posizionamento_secondi;
                        for(let t = pEffettiva; t > 0; t--) {
                            elTimer.innerText = t;
                            if(t === 5) parla("Prepararsi");
                            if(t <= 3) parla(t.toString());
                            await attendi(1000);
                        }
                    }
                }
                parla(`Giro ${g} completato.`);
                await attendi(2000);
            }

            elEsercizio.innerText = "FINE";
            parla("Allenamento completato. Ottimo lavoro.");
            if (wakeLock) wakeLock.release();
        });

        caricaConfigurazione();
    </script>
</body>

</html>
